<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBCG APP - Liturgia 2025 (Ciclo C)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
<style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Merriweather', serif;
            background-image: url('https://www.bibleserver.com/build/bs-start-back-Dno9hVpC.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #433A3F; 
        }
        h1, h2, h3, h4, h5, h6, .nav-item, .filter-button, .main-nav-button {
            font-family: 'Roboto', sans-serif;
        }
        .liturgy-text {
            transition: all 0.3s ease-in-out;
            border-left: 4px solid transparent;
            padding-left: 1rem;
            margin-top: 1rem;
            line-height: 1.8;
        }
        #main-header {
            transition: transform 0.3s ease-in-out;
        }
        .header-hidden {
            transform: translateY(-100%);
        }
        .ref-link {
            cursor: pointer;
            font-weight: bold;
            color: #0f766e; /* teal-700 */
            text-decoration: none;
            position: relative;
        }
        .ref-link sup {
            font-size: 0.7em;
            vertical-align: super;
            margin-left: 1px;
            font-weight: 900;
        }
        #theology-popup {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            width: 90%;
            max-width: 350px;
            z-index: 110;
            font-family: 'Merriweather', serif;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #334155;
        }
        #theology-popup h5 {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            color: #0d9488;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        #theology-popup .original-term {
            font-size: 1.5rem;
            font-family: 'Times New Roman', serif;
        }
        #popup-close {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #94a3b8;
            cursor: pointer;
            line-height: 1;
        }
        #popup-close:hover { color: #475569; }
        
        /* Full Screen Liturgy View Styles */
        #full-liturgy-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #FDFBF5; z-index: 100; overflow-y: auto;
        }
        .liturgy-section h2 {
            font-size: 1.5rem; md:font-size: 1.75rem; font-weight: 700; border-bottom: 2px solid #fBBF24; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2.5rem; color: #1e293b;
        }
         .liturgy-section h3 {
            font-size: 1.1rem; md:font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #334155;
        }
        
        /* Bible View Styles */
        .book-button {
            width: 100%; text-align: left; padding: 0.5rem 0.75rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; font-size: 0.9rem;
        }
        .book-button:hover:not(:disabled) { background-color: #f3f4f6; }
        .book-button:disabled { color: #9ca3af; cursor: not-allowed; }
        .book-button.active { background-color: #0d9488; color: white; font-weight: 600; }
        #chapter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 0.5rem; margin-top: 1rem; }
        .chapter-button {
            aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; border: 1px solid #d1d5db; border-radius: 9999px; transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .chapter-button:hover { background-color: #fef3c7; border-color: #fBBF24; }
        .chapter-button.active { background-color: #0d9488; color: white; border-color: #0d9488; font-weight: 600; }
        #bible-chapter-content sup { font-size: 0.65em; vertical-align: super; color: #0f766e; font-weight: bold; margin-right: 0.2em; line-height: 1; }
        #bible-chapter-content p { line-height: 1.9; }

        #back-to-chapters-mobile { display: none; }

        @media (max-width: 767px) {
            .mobile-content-focused #bible-nav {
                display: none;
            }
            .mobile-content-focused #bible-content-wrapper {
                width: 100%;
            }
            .mobile-content-focused #back-to-chapters-mobile {
                display: flex;
            }
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1489664942048-a3a60914a2f4?q=80&w=2070&auto=format&fit=crop');
            background-size: cover; background-position: center;
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
            transition: opacity 1.5s ease-in-out;
            padding: 1rem;
        }
        #splash-screen.fade-out {
            opacity: 0;
        }
        .splash-title {
            font-family: 'Merriweather', serif;
            font-size: 2.5rem; sm:font-size: 3rem; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .splash-subtitle {
            font-family: 'Roboto', sans-serif;
            font-size: 1.1rem; sm:font-size: 1.25rem; margin-top: 0.5rem; text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        /* New Menu */
        .main-nav-button {
            padding: 0.5rem 0;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem; sm:font-size: 1rem;
        }
        .main-nav-button:hover {
            color: #0d9488; /* teal-600 */
            border-bottom-color: #99f6e4; /* teal-200 */
        }
        .active-nav {
            color: #0f766e; /* teal-700 */
            font-weight: 700;
            border-bottom-color: #0f766e; /* teal-700 */
        }
        
        /* Accordion Styles */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .accordion-icon {
            transition: transform 0.3s ease-in-out;
        }
        .is-open + .accordion-content {
            max-height: 1000px; /* Adjust if list is longer */
        }
        .is-open .accordion-icon {
            transform: rotate(180deg);
        }

        /* Liturgical Cards Styles */
        .liturgical-card {
            background-color: white;
            border-left-width: 6px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .liturgical-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Print Styles */
        .print-only-header { display: none; }
        @media print {
            @page {
                size: letter landscape;
                margin: 1cm;
            }
            body, html { background-color: white !important; }
            body > *:not(#full-liturgy-view) { display: none; }
            #full-liturgy-view {
                position: static; width: auto; height: auto; overflow: visible; background-color: white !important;
            }
            #full-liturgy-header { display: none; }
            .print-only-header { display: block; text-align: center; margin-bottom: 1cm; break-after: avoid; }
            .print-title { font-size: 16pt; font-weight: bold; font-family: 'Times New Roman', Times, serif; }
            .print-subtitle { font-size: 12pt; font-style: italic; font-family: 'Times New Roman', Times, serif; }
            #full-liturgy-content { padding: 0; margin: 0; }
            .print-liturgy-body { column-count: 2; column-gap: 1.5cm; }
            .liturgy-section { break-inside: avoid; }
            .liturgy-section h2 { font-size: 14pt !important; color: black !important; border-bottom: 2px solid black; break-after: avoid; padding-top: 1em; }
            .liturgy-section:first-of-type h2 { padding-top: 0; }
            .liturgy-section h3 { font-size: 11pt !important; color: black !important; }
            body, .liturgy-text, p { font-family: 'Times New Roman', Times, serif; font-size: 10pt !important; color: black !important; background-color: white !important; }
            .ref-link { display: none; }
            #full-liturgy-content .bg-white { box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body class="antialiased">

    <div id="splash-screen">
        <h1 class="splash-title">Comunidad de Gracia</h1>
        <p class="splash-subtitle">Liturgia y Recursos</p>
    </div>

    <div id="main-content" class="opacity-0 transition-opacity duration-500">
        <header id="main-header" class="bg-white/80 backdrop-blur-sm shadow-sm py-2 px-4 sticky top-0 z-20">
            <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center gap-2">
                <!-- Logo and Title -->
                <div class="flex items-center gap-3 self-start sm:self-center">
                    <img id="logo-image" src="https://scontent-mia3-1.xx.fbcdn.net/v/t39.30808-1/458442022_122107426106496454_2577487987417874050_n.jpg?stp=dst-jpg_s200x200_tt6&_nc_cat=111&ccb=1-7&_nc_sid=2d3e12&_nc_ohc=Zy1TV0kujjIQ7kNvwEz8bgt&_nc_oc=Adl4Yh0O1zq-mS8LlfMHzCmTKgBM-yzBhJyyNVnQtxBS9eQMVoKdbqWamxJjkk23f78&_nc_zt=24&_nc_ht=scontent-mia3-1.xx&_nc_gid=AuKzGmho4nnugwzcXEAx7A&oh=00_AfQLVtVuH2tLlf7fZE-otz8oogECgeQlPogoM7mnCAewGA&oe=68938DFE" onerror="this.onerror=null;this.src='https://placehold.co/100x100/3A5F7D/FFFFFF?text=Logo';" alt="Logo Comunidad de Gracia" class="h-10 w-auto rounded-full">
                    <h1 class="text-lg sm:text-xl font-bold text-gray-800">IBCG APP</h1>
                </div>
                <!-- Navigation Buttons -->
                <nav class="flex flex-wrap justify-center items-center gap-x-3 gap-y-1 sm:gap-x-4 md:gap-x-6 w-full sm:w-auto">
                    <a id="btn-home" class="main-nav-button cursor-pointer">Inicio</a>
                    <a id="btn-liturgy" class="main-nav-button cursor-pointer">Liturgia</a>
                    <a id="btn-bible" class="main-nav-button cursor-pointer">Biblia</a>
                    <a id="btn-glossary" class="main-nav-button cursor-pointer">Recursos</a>
                    <a id="btn-lectionary" class="main-nav-button cursor-pointer">Leccionario</a>
                    <a href="https://www.bibleserver.com/nicodemus-ai" target="_blank" rel="noopener noreferrer" class="main-nav-button">Nicodemus IA</a>
                    <a id="btn-upload-logo" class="main-nav-button cursor-pointer">
                        <svg class="w-6 h-6 text-gray-600 hover:text-teal-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </a>
                </nav>
            </div>
        </header>

        <input type="file" id="logo-uploader" class="hidden" accept="image/*">

        <div id="home-view" class="min-h-[85vh]">
            <!-- This div is intentionally empty to show the body background -->
        </div>

        <div id="liturgy-view" class="hidden">
            <main class="container mx-auto p-4">
                <div class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 rounded-lg shadow-2xl">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center border-b-2 border-amber-400 pb-3">Calendario Litúrgico 2025</h2>
                    <div id="liturgical-cards-container" class="space-y-4">
                        <!-- Liturgical cards will be inserted here by JavaScript -->
                    </div>
                </div>
            </main>
        </div>

        <div id="bible-view" class="hidden">
             <main class="container mx-auto p-4">
                <h2 class="text-2xl sm:text-3xl font-bold border-b-2 border-amber-400 pb-2 mb-4 sm:mb-6 text-gray-800 bg-white/80 backdrop-blur-sm rounded-t-lg px-4 py-2">Biblia - El Libro del Pueblo de Dios</h2>
                <div id="bible-flex-container" class="flex flex-col md:flex-row gap-6">
                    <!-- Navigation Panel -->
                    <nav id="bible-nav" class="md:w-1/3 lg:w-1/4 bg-white/80 backdrop-blur-sm p-4 rounded-lg shadow-lg self-start md:sticky top-24">
                         <div id="book-list-container" class="space-y-2">
                             <div>
                                 <button class="accordion-header flex items-center justify-between w-full p-3 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                                     <span class="font-bold text-teal-800">Antiguo Testamento</span>
                                     <svg class="accordion-icon w-5 h-5 text-teal-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                 </button>
                                 <div id="ot-books" class="accordion-content pl-4 pt-2 space-y-1"></div>
                             </div>
                             <div>
                                 <button class="accordion-header flex items-center justify-between w-full p-3 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                                     <span class="font-bold text-teal-800">Nuevo Testamento</span>
                                     <svg class="accordion-icon w-5 h-5 text-teal-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                 </button>
                                 <div id="nt-books" class="accordion-content pl-4 pt-2 space-y-1"></div>
                            </div>
                         </div>
                         <div id="chapter-list-container" class="hidden">
                            <button id="back-to-books-btn" class="mb-4 flex items-center gap-2 text-sm font-semibold text-gray-600 hover:text-gray-900">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                                Volver a Libros
                            </button>
                            <h3 id="chapter-list-title" class="text-xl font-bold mb-3 text-teal-800"></h3>
                            <div id="chapter-grid"></div>
                         </div>
                    </nav>
                    <!-- Content Panel -->
                    <div id="bible-content-wrapper" class="md:w-2/3 lg:w-3/4 relative">
                        <button id="back-to-chapters-mobile" class="sticky top-24 left-0 z-10 bg-white/80 backdrop-blur-sm p-2 rounded-full shadow-lg items-center justify-center text-gray-600 hover:text-gray-900">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div id="bible-chapter-content" class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 rounded-lg shadow-inner min-h-[75vh] prose max-w-none mt-4 md:mt-0">
                            <div class="flex items-center justify-center h-full text-center text-gray-500">
                                <p>Seleccione un libro y capítulo para comenzar la lectura.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="glossary-view" class="hidden">
            <main class="container mx-auto p-4 md:p-8">
                <div class="bg-white/80 backdrop-blur-sm p-6 sm:p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl sm:text-3xl font-bold border-b-2 border-amber-400 pb-2 mb-6 text-gray-800">ACNA: Libro de Oración Común y Recursos</h2>
                    <div class="mt-8 text-center bg-stone-100 p-6 sm:p-8 rounded-lg shadow">
                        <p class="text-lg text-gray-700 mb-4">Para acceder a los recursos del Libro de Oración Común, por favor haz clic en el siguiente botón. El sitio se abrirá en una nueva pestaña del navegador.</p>
                        <a href="https://bcp2019.anglicanchurch.net/index.php/downloads-espanol/" target="_blank" rel="noopener noreferrer" class="inline-block bg-teal-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-700 transition-colors shadow-md">
                            Ir a Recursos ACNA
                        </a>
                    </div>
                </div>
            </main>
        </div>

        <div id="lectionary-view" class="hidden">
            <main class="container mx-auto p-4 md:p-8 flex items-center justify-center min-h-[85vh]">
                <div class="w-full max-w-2xl bg-white/80 backdrop-blur-sm p-6 sm:p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl sm:text-3xl font-bold border-b-2 border-amber-400 pb-2 mb-6 text-gray-800">Leccionario Diario 2025</h2>
                    <div class="mt-8 text-center bg-stone-100 p-6 sm:p-8 rounded-lg shadow">
                        <p class="text-lg text-gray-700 mb-6">El Leccionario Diario se abrirá en una nueva pestaña del navegador para una mejor experiencia de visualización.</p>
                        <a href="https://liturgical-calendar.com/es/ACNA2019/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-3 bg-teal-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-700 transition-colors shadow-md">
                            <span>Abrir Leccionario</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                    </div>
                </div>
            </main>
        </div>
        
        <footer class="bg-gray-800/90 text-white py-6 px-4">
            <div class="container mx-auto text-center">
                <p>&copy; 2025 IBCG APP. Todos los derechos reservados.</p>
                <p class="text-sm text-gray-400 mt-2">Textos litúrgicos del Misal Romano. Textos bíblicos de la Conferencia Episcopal Española.</p>
            </div>
        </footer>
    </div>

    <div id="full-liturgy-view" class="hidden">
        <header id="full-liturgy-header" class="sticky top-0 bg-white/95 backdrop-blur-sm shadow-md z-10">
            <div class="container mx-auto flex items-center justify-between p-2 sm:p-4">
                <button id="back-to-calendar-btn" title="Volver al calendario" class="flex-shrink-0 flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <span class="hidden sm:inline font-semibold text-base">Volver</span>
                </button>
                <div class="flex-grow text-center min-w-0 px-2">
                    <h1 id="full-liturgy-title" class="text-sm sm:text-base md:text-lg font-bold text-gray-800 truncate"></h1>
                    <p id="full-liturgy-subtitle" class="text-xs text-gray-600 truncate"></p>
                </div>
                <div class="flex-shrink-0 flex items-center gap-2 sm:gap-4">
                    <button id="download-docx-btn" title="Descargar como DOCX" class="text-gray-600 hover:text-gray-900 transition-colors p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    <button id="print-btn" title="Imprimir Liturgia" class="text-gray-600 hover:text-gray-900 transition-colors p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    </button>
                </div>
            </div>
        </header>
        <main id="full-liturgy-content" class="container mx-auto p-4 md:p-8">
            
</main>
    </div>

    <div id="theology-popup">
        <span id="popup-close">&times;</span>
        <div id="popup-content-theology"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- HELPER FUNCTIONS ---
            const addDays = (d, days) => { const res = new Date(d); res.setDate(d.getDate() + days); return res; };
            
            // --- MINIMAL BIBLE DATA FOR PERFORMANCE ---
            const placeholderChapter = (chapterNum) => ([{ verse: 1, text: `[Texto del capítulo ${chapterNum} no cargado para optimizar el rendimiento.]` }]);
            const bibleData = [
                { "name": "Génesis", "testament": "OT", "chapters": [[{"verse":1,"text":"Al principio Dios creó el cielo y la tierra."}],...Array.from({ length: 49 }, (_, i) => placeholderChapter(i + 2))]},
                { "name": "Sabiduría", "testament": "OT", "chapters": Array.from({ length: 19 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "Salmos", "testament": "OT", "chapters": [[{"verse":1,"text":"¡Feliz el hombre que no sigue el consejo de los malvados..."}],...Array.from({ length: 149 }, (_, i) => placeholderChapter(i + 2))]},
                { "name": "Eclesiastés", "testament": "OT", "chapters": Array.from({ length: 12 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "Isaías", "testament": "OT", "chapters": Array.from({ length: 66 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "Mateo", "testament": "NT", "chapters": Array.from({ length: 28 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "Lucas", "testament": "NT", "chapters": Array.from({ length: 24 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "Juan", "testament": "NT", "chapters": Array.from({ length: 21 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "Romanos", "testament": "NT", "chapters": Array.from({ length: 16 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "1 Corintios", "testament": "NT", "chapters": Array.from({ length: 16 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "Colosenses", "testament": "NT", "chapters": Array.from({ length: 4 }, (_, i) => placeholderChapter(i + 1)) },
                { "name": "Hebreos", "testament": "NT", "chapters": Array.from({ length: 13 }, (_, i) => placeholderChapter(i + 1)) },
            ];

            // --- COMPLETE LITURGICAL DATA GENERATOR ---
            function getLiturgyForDate(date) {
                const year = date.getFullYear();
                if (year !== 2025) return null;

                const toYYYYMMDD = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const dateString = toYYYYMMDD(date);
                
                const easter = new Date(2025, 3, 20);
                const firstSundayOfAdvent = new Date(2025, 10, 30);

                let season = 'Ordinary Time';
                let seasonColor = '#16a34a'; // green-600
                if (date >= firstSundayOfAdvent && date < new Date(2025, 11, 25)) { season = 'Advent'; seasonColor = '#6d28d9'; } // violet-700
                else if ((date >= new Date(2025, 11, 25)) || (date < new Date(2025, 0, 12))) { season = 'Christmas'; seasonColor = '#ca8a04'; } // yellow-600
                else if (date >= new Date(2025, 2, 5) && date < easter) { season = 'Lent'; seasonColor = '#9333ea'; } // purple-600
                else if (date >= easter && date <= addDays(easter, 50)) { season = 'Easter'; seasonColor = '#f59e0b'; } // amber-500

                let liturgy = {
                    title: '', cycle: '', omitGloria: false, omitCredo: false, omitAlleluia: false, seasonColor: seasonColor,
                    prayers: { collect: '', offerings: '', postCommunion: '', preface: ''},
                    readings: { firstReading: null, psalm: null, secondReading: null, alleluiaVerse: null, gospelAcclamationVerse: null, gospel: null }
                };
                
                // --- Theological Term Data ---
                const terms = {
                    hypostasis: {original: "ὑπόστασις", transliteration: "hypóstasis", meaning: "Sustancia, fundamento, garantía. En este contexto, la fe es la realidad fundamental de lo que se espera."},
                    elenchos: {original: "ἔλεγχος", transliteration: "élenchos", meaning: "Prueba, convicción. La fe proporciona una certeza interior sobre realidades que no se ven."},
                    epangelia: {original: "ἐπαγγελία", transliteration: "epangelía", meaning: "Promesa. Un compromiso divino que es el objeto de la esperanza y la fe del creyente."},
                    poimnion: {original: "ποίμνιον", transliteration: "poímnion", meaning: "Rebaño pequeño. Término de cariño y ternura que Jesús usa para sus discípulos, destacando su vulnerabilidad y la protección de Dios."},
                    kardia: {original: "καρδία", transliteration: "kardía", meaning: "Corazón. En la Biblia, no es solo el asiento de las emociones, sino el centro del intelecto, la voluntad y toda la persona."},
                    gregoreō: {original: "γρηγορέω", transliteration: "grēgoreō", meaning: "Velar, estar despierto. Una actitud de alerta espiritual y preparación constante para la venida del Señor."},
                    doulos: {original: "δοῦλος", transliteration: "doûlos", meaning: "Siervo, esclavo. Describe la total devoción y obediencia a un amo; en el Nuevo Testamento, se usa para la relación del creyente con Cristo."}
                };

                const ref = (key, num) => `<span class="ref-link" data-term='${JSON.stringify(terms[key]).replace(/'/g, "&#39;")}'><sup>${num}</sup></span>`;

                const placeholderReadings = {
                    firstReading: { ref: 'Lectura I', text: 'Texto de la primera lectura no disponible.' },
                    psalm: { ref: 'Salmo Responsorial', response: 'Respuesta del salmo.', stanzas: ['Estrofa del salmo no disponible.'] },
                    secondReading: { ref: 'Lectura II', text: 'Texto de la segunda lectura no disponible.' },
                    alleluiaVerse: 'Versículo del Aleluya no disponible.',
                    gospel: { ref: 'Evangelio', text: 'Texto del Evangelio no disponible.' }
                };

                // --- SEASONAL FLAGS ---
                if (season === 'Advent' || season === 'Lent') { liturgy.omitGloria = true; }
                if (season === 'Lent') { liturgy.omitAlleluia = true; }

                // --- SOLEMNITIES AND FEASTS (OVERRIDE SUNDAY LOGIC) ---
                const solemnities = {
                    '2025-01-01': { title: 'Santa María, Madre de Dios', seasonColor: '#e5e7eb' },
                    '2025-01-05': { title: 'Epifanía del Señor', seasonColor: '#e5e7eb' }, // Sunday
                    '2025-01-12': { title: 'Bautismo del Señor', seasonColor: '#e5e7eb' }, // Sunday
                    '2025-03-05': { title: 'Miércoles de Ceniza', seasonColor: '#9333ea' },
                    '2025-04-13': { title: 'Domingo de Ramos', seasonColor: '#dc2626' }, // Sunday
                    '2025-04-17': { title: 'Jueves Santo (Misa de la Cena del Señor)', seasonColor: '#e5e7eb' },
                    '2025-04-18': { title: 'Viernes Santo (Pasión del Señor)', seasonColor: '#dc2626' },
                    '2025-04-19': { title: 'Sábado Santo (Vigilia Pascual)', seasonColor: '#f59e0b' },
                    '2025-04-20': { title: 'Domingo de Pascua', seasonColor: '#f59e0b' }, // Sunday
                    '2025-06-01': { title: 'Ascensión del Señor', seasonColor: '#e5e7eb' }, // Sunday
                    '2025-06-08': { title: 'Domingo de Pentecostés', seasonColor: '#dc2626' }, // Sunday
                    '2025-06-15': { title: 'Santísima Trinidad', seasonColor: '#e5e7eb' }, // Sunday
                    '2025-06-22': { title: 'Santísimo Cuerpo y Sangre de Cristo', seasonColor: '#e5e7eb' }, // Sunday
                    '2025-08-15': { title: 'Asunción de la Virgen María', seasonColor: '#e5e7eb' },
                    '2025-11-01': { title: 'Todos los Santos', seasonColor: '#e5e7eb' },
                    '2025-11-23': { title: 'Jesucristo, Rey del Universo', seasonColor: '#e5e7eb' }, // Sunday
                    '2025-12-08': { title: 'Inmaculada Concepción de la Virgen María', seasonColor: '#e5e7eb' },
                    '2025-12-25': { title: 'Natividad del Señor (Navidad)', seasonColor: '#f59e0b' },
                };

                if (solemnities[dateString]) {
                    liturgy.title = solemnities[dateString].title;
                    liturgy.seasonColor = solemnities[dateString].seasonColor;
                    liturgy.cycle = 'Solemnidad';
                    liturgy.readings = placeholderReadings; 
                }

                // --- ORDINARY SUNDAYS (CYCLE C) ---
                if (date.getDay() === 0 && !solemnities[dateString]) {
                     if (dateString === '2025-07-27') {
                        liturgy.title = 'XVII Domingo del Tiempo Ordinario';
                        liturgy.cycle = 'Ciclo C';
                        liturgy.readings = placeholderReadings;
                    } else if (dateString === '2025-08-03') {
                        liturgy.title = 'XVIII Domingo del Tiempo Ordinario';
                        liturgy.cycle = 'Ciclo C';
                        liturgy.readings = placeholderReadings;
                    } else if (dateString === '2025-08-10') {
                        liturgy.title = 'XIX Domingo del Tiempo Ordinario';
                        liturgy.cycle = 'Ciclo C';
                        liturgy.prayers = {
                            collect: 'Dios todopoderoso y eterno, a quien podemos llamar Padre, aumenta en nuestros corazones el espíritu de hijos adoptivos, para que merezcamos entrar un día en la herencia prometida. Por nuestro Señor Jesucristo.',
                            offerings: 'Sé propicio, Señor, a tu pueblo y acepta con bondad estas ofrendas, para que, con la ayuda de tu piedad, a cada uno le aproveche para su salvación lo que ofrece en honor de tu nombre. Por Jesucristo, nuestro Señor.',
                            postCommunion: 'Que la comunión en tus sacramentos nos salve, Señor, y nos afiance en la luz de tu verdad. Por Jesucristo, nuestro Señor.',
                            preface: 'En verdad es justo y necesario, es nuestro deber y salvación darte gracias siempre y en todo lugar, Señor, Padre santo, Dios todopoderoso y eterno. Pues, aunque no necesitas nuestra alabanza, es don tuyo que seamos agradecidos; y aunque nuestras bendiciones no aumentan tu gloria, nos aprovechan para nuestra salvación. Por Cristo, Señor nuestro. Por eso, unidos a los ángeles, te aclamamos llenos de alegría:'
                        };
                        liturgy.readings = {
                            firstReading: { ref: 'Sabiduría 18, 6-9', text: `La noche de la liberación fue anunciada de antemano a nuestros padres, para que tuvieran ánimo al conocer con certeza la promesa de la que se fiaban. Tu pueblo esperaba, a la vez, la salvación de los justos y la perdición de los enemigos. Porque con la misma acción que castigaste a los adversarios, nos glorificaste a nosotros, llamándonos a ti. Los santos hijos de los buenos ofrecían sacrificios a escondidas y establecieron de común acuerdo esta ley divina: que los santos compartirían por igual los mismos bienes y peligros; y entonaron los himnos de los padres.` },
                            psalm: { ref: 'Salmo 32', response: 'Dichoso el pueblo que el Señor se escogió como heredad.', stanzas: [ `Aclamad, justos, al Señor,<br>que merece la alabanza de los buenos.<br>Dichosa la nación cuyo Dios es el Señor,<br>el pueblo que él se escogió como heredad.`, `El Señor mira desde el cielo,<br>se fija en todos los hombres.<br>Desde su morada observa<br>a todos los habitantes de la tierra.`, `Los ojos del Señor están puestos en quien lo teme,<br>en los que esperan en su misericordia,<br>para librar sus vidas de la muerte<br>y reanimarlos en tiempo de hambre.`, `Nosotros aguardamos al Señor:<br>él es nuestro auxilio y escudo;<br>que tu misericordia, Señor, venga sobre nosotros,<br>como lo esperamos de ti.` ] },
                            secondReading: { ref: 'Hebreos 11, 1-2. 8-19', text: `Hermanos: La fe es garantía${ref('hypostasis', 1)} de lo que se espera, la prueba${ref('elenchos', 2)} de las realidades que no se ven. Por ella fueron alabados nuestros mayores. Por la fe, Abrahán, al ser llamado por Dios, obedeció y salió para el lugar que había de recibir en herencia, y salió sin saber a dónde iba. Por la fe, se estableció en la tierra prometida como en tierra extraña, viviendo en tiendas, y lo mismo Isaac y Jacob, herederos de la misma promesa${ref('epangelia', 3)}, pues esperaba la ciudad de sólidos cimientos, cuyo arquitecto y constructor es Dios. Por la fe, también Sara, siendo estéril, obtuvo vigor para concebir, a pesar de su edad avanzada, porque creyó que era fiel el que se lo prometía. Y así, de un solo hombre, y ya marcado por la muerte, nacieron hijos, numerosos como las estrellas del cielo e incontables como la arena de las playas. Con fe murieron todos estos, sin haber recibido las promesas; las vieron y las saludaron de lejos, confesando que eran extraños y peregrinos en la tierra. Los que así hablan, dan a entender que buscan una patria; pues si hubieran pensado en la que habían abandonado, tenían ocasión de volver. Pero ellos ansiaban una patria mejor, la celestial. Por eso Dios no se avergüenza de llamarse su Dios, pues les tenía preparada una ciudad. Por la fe, Abrahán, puesto a prueba, ofreció a Isaac; y el que había recibido las promesas, ofrecía a su unigénito, a quien se le había dicho: «La descendencia que lleve tu nombre será la de Isaac». Pero Abrahán pensaba que Dios tiene poder hasta para resucitar de entre los muertos, de donde en cierto sentido lo recobró.` },
                            alleluiaVerse: 'Estad en vela y preparados, porque a la hora que menos penséis viene el Hijo del hombre. (cf. Mt 24, 42a. 44)',
                            gospel: { ref: 'Lucas 12, 32-48', text: `En aquel tiempo, dijo Jesús a sus discípulos: «No temas, pequeño rebaño${ref('poimnion', 4)}, porque vuestro Padre ha tenido a bien daros el reino. Vended vuestros bienes y dad limosna. Haceos bolsas que no se estropeen, un tesoro inagotable en el cielo, adonde no se acercan los ladrones ni roe la polilla. Porque donde está vuestro tesoro, allí estará también vuestro corazón${ref('kardia', 5)}. Tened ceñida la cintura y encendidas las lámparas. Vosotros estad como los hombres que aguardan a que su señor vuelva de la boda, para abrirle apenas venga y llame. Bienaventurados aquellos criados a quienes el señor, al llegar, los encuentre en vela${ref('gregoreō', 6)}; en verdad os digo que se ceñirá, los hará sentar a la mesa y, acercándose, les irá sirviendo. Y, si llega a la segunda vigilia o a la tercera y los encuentra así, ¡bienaventurados ellos! Comprended que si supiera el dueño de casa a qué hora viene el ladrón, no le dejaría abrir un boquete en su casa. Lo mismo vosotros, estad preparados, porque a la hora que menos penséis viene el Hijo del hombre». Pedro le dijo: «Señor, ¿dices esta parábola por nosotros o por todos?». Y el Señor dijo: «¿Quién es el administrador fiel y prudente a quien el señor pondrá al frente de su servidumbre para que reparta la ración de alimento a sus horas? Bienaventurado aquel siervo${ref('doulos', 7)} a quien su señor, al llegar, lo encuentre portándose así. En verdad os digo que lo pondrá al frente de todos sus bienes. Pero si aquel siervo dijere para sus adentros: “Mi señor tarda en llegar”, y empieza a pegarles a los criados y a las criadas, a comer y beber y emborracharse, vendrá el señor de ese siervo el día que menos lo espera y a la hora que no sabe y lo castigará con rigor, y le asignará la suerte de los infieles. El siervo que, conociendo la voluntad de su señor, no se prepara ni obra de acuerdo con su voluntad, recibirá muchos azotes; pero el que, sin conocerla, ha hecho algo digno de azotes, recibirá menos. A quien mucho se le dio, mucho se le reclamará; a quien mucho se le confió, más aún se le pedirá».` }
                        };
                    } else {
                        // Placeholder for other Sundays
                        liturgy.title = `Domingo de ${season}`;
                        liturgy.cycle = 'Ciclo C';
                        liturgy.readings = placeholderReadings;
                    }
                }
                
                if (!liturgy.title) return null; // If no title was set, it's not a liturgical day we're tracking.

                return liturgy;
            }
            
            // --- DOM ELEMENTS & STATE ---
            const splashScreen = document.getElementById('splash-screen');
            const mainContent = document.getElementById('main-content');
            const fullLiturgyView = document.getElementById('full-liturgy-view');
            const backToCalendarBtn = document.getElementById('back-to-calendar-btn');
            const printBtn = document.getElementById('print-btn');
            const downloadDocxBtn = document.getElementById('download-docx-btn');
            const mainNavButtons = { 
                home: document.getElementById('btn-home'),
                liturgy: document.getElementById('btn-liturgy'), 
                bible: document.getElementById('btn-bible'),
                glossary: document.getElementById('btn-glossary'), 
                lectionary: document.getElementById('btn-lectionary')
            };
            const views = { 
                home: document.getElementById('home-view'),
                liturgy: document.getElementById('liturgy-view'), 
                bible: document.getElementById('bible-view'),
                glossary: document.getElementById('glossary-view'), 
                lectionary: document.getElementById('lectionary-view')
            };
            
            const fullLiturgyUI = { title: document.getElementById('full-liturgy-title'), subtitle: document.getElementById('full-liturgy-subtitle'), content: document.getElementById('full-liturgy-content') };
            const uploadLogoBtn = document.getElementById('btn-upload-logo');
            const logoUploader = document.getElementById('logo-uploader');
            const logoImage = document.getElementById('logo-image');
            const theologyPopup = document.getElementById('theology-popup');
            const theologyPopupContent = document.getElementById('popup-content-theology');
            const theologyPopupClose = document.getElementById('popup-close');
            const cardsContainer = document.getElementById('liturgical-cards-container');

            // Bible View Elements
            const bibleFlexContainer = document.getElementById('bible-flex-container');
            const bibleContentWrapper = document.getElementById('bible-content-wrapper');
            const backToChaptersMobileBtn = document.getElementById('back-to-chapters-mobile');
            const bibleNav = {
                bookListContainer: document.getElementById('book-list-container'),
                chapterListContainer: document.getElementById('chapter-list-container'),
                otBooks: document.getElementById('ot-books'),
                ntBooks: document.getElementById('nt-books'),
                backToBooksBtn: document.getElementById('back-to-books-btn'),
                chapterListTitle: document.getElementById('chapter-list-title'),
                chapterGrid: document.getElementById('chapter-grid')
            };
            const bibleContent = document.getElementById('bible-chapter-content');
            let activeBookButton = null;

            // --- FUNCTIONS ---
            function switchView(viewName) {
                Object.values(views).forEach(v => v.classList.add('hidden'));
                Object.values(mainNavButtons).forEach(b => b.classList.remove('active-nav'));
                if (views[viewName]) {
                    views[viewName].classList.remove('hidden');
                }
                if (mainNavButtons[viewName]) {
                    mainNavButtons[viewName].classList.add('active-nav');
                }
            }
            
            function renderLiturgicalCards() {
                cardsContainer.innerHTML = '';
                const startDate = new Date(2025, 0, 1);
                const endDate = new Date(2025, 11, 31);

                for (let d = startDate; d <= endDate; d.setDate(d.getDate() + 1)) {
                    const liturgyData = getLiturgyForDate(new Date(d));
                    if (liturgyData) {
                        const card = document.createElement('div');
                        card.className = 'liturgical-card flex items-center p-4 rounded-lg shadow-md cursor-pointer';
                        card.style.borderColor = liturgyData.seasonColor;
                        card.dataset.date = d.toISOString().split('T')[0];
                        
                        card.innerHTML = `
                            <div class="flex-shrink-0 w-20 text-center">
                                <p class="text-gray-500 text-sm">${d.toLocaleDateString('es-ES', { weekday: 'short' }).replace('.', '')}</p>
                                <p class="text-2xl font-bold text-gray-800">${d.getDate()}</p>
                                <p class="text-gray-500 text-sm">${d.toLocaleDateString('es-ES', { month: 'short' }).replace('.', '')}</p>
                            </div>
                            <div class="flex-grow pl-4">
                                <h3 class="font-bold text-lg text-gray-900">${liturgyData.title}</h3>
                                <p class="text-sm text-gray-600">${liturgyData.cycle}</p>
                            </div>
                            <div class="flex-shrink-0">
                               <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        `;
                        cardsContainer.appendChild(card);
                    }
                }
            }

            function showFullLiturgy(date) {
                renderFullLiturgyView(date); 
                mainContent.classList.add('hidden');
                fullLiturgyView.classList.remove('hidden');
                fullLiturgyView.scrollTop = 0;
            }

            function renderFullLiturgyView(date) {
                const liturgy = getLiturgyForDate(date);
                if (liturgy && liturgy.readings && liturgy.readings.firstReading.text !== 'Texto de la primera lectura no disponible.') {
                    fullLiturgyUI.title.textContent = liturgy.title;
                    const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    fullLiturgyUI.subtitle.textContent = `${formattedDate} | ${liturgy.cycle}`;
                    
                    const templates = { // Re-define templates locally for this function
                        initialGreeting: `<h3>Saludo Inicial</h3><p class="liturgy-text">En el nombre del Padre, y del Hijo, y del Espíritu Santo.<br><strong>Amén.</strong><br>La gracia de nuestro Señor Jesucristo, el amor del Padre y la comunión del Espíritu Santo esté con todos ustedes.<br><strong>Y con tu espíritu.</strong></p>`,
                        penitentialAct: `<h3>Acto Penitencial (Libro de Oración Común ACNA)</h3><p class="liturgy-text">Amados en el Señor, acerquémonos con un corazón penitente y obediente a la Palabra de Dios, confesando nuestros pecados para que podamos recibir el perdón por su infinita bondad y misericordia.<br><em>Se guarda un momento de silencio.</em><br><strong>Misericordiosísimo Dios, confesamos que hemos pecado contra ti en pensamiento, palabra y obra, por lo que hemos hecho y por lo que hemos dejado de hacer. No te hemos amado con todo nuestro corazón; no hemos amado a nuestro prójimo como a nosotros mismos. Lo sentimos de veras y nos arrepentimos humildemente. Por tu Hijo Jesucristo, ten misericordia de nosotros y perdónanos, para que nos deleitemos en tu voluntad y andemos en tus caminos, para la gloria de tu Nombre. Amén.</strong><br>Dios todopoderoso tenga misericordia de nosotros, perdone nuestros pecados y nos lleve a la vida eterna.<br><strong>Amén.</strong></p>`,
                        gloria: `<h3>Gloria</h3><p class="liturgy-text"><strong>Gloria a Dios en el cielo, y en la tierra paz a los hombres que ama el Señor. Por tu inmensa gloria te alabamos, te bendecimos, te adoramos, te glorificamos, te damos gracias, Señor Dios, Rey celestial, Dios Padre todopoderoso. Señor, Hijo único, Jesucristo. Señor Dios, Cordero de Dios, Hijo del Padre; tú que quitas el pecado del mundo, ten piedad de nosotros; tú que quitas el pecado del mundo, atiende nuestra súplica; tú que estás sentado a la derecha del Padre, ten piedad de nosotros. Porque sólo tú eres Santo, sólo tú Señor, sólo tú Altísimo, Jesucristo, con el Espíritu Santo en la gloria de Dios Padre. Amén.</strong></p>`,
                        alleluia: (verse) => `<h3>Aleluya</h3><p class="liturgy-text"><strong>Aleluya, aleluya.</strong><br>${verse}<br><strong>Aleluya.</strong></p>`,
                        gospelAcclamation: (verse) => `<h3>Aclamación antes del Evangelio</h3><p class="liturgy-text">${verse}</p>`,
                        gospel: (gospelData) => `<h3>Evangelio: ${gospelData.ref}</h3><p class="liturgy-text">El Señor esté con ustedes.<br><strong>Y con tu espíritu.</strong><br>Lectura del santo Evangelio según san ${gospelData.ref.split(' ')[0]}.<br><strong>Gloria a ti, Señor.</strong></p><p class="liturgy-text">${gospelData.text}</p><p class="liturgy-text">Palabra del Señor.<br><strong>Gloria a ti, Señor Jesús.</strong></p>`,
                        credo: `<h3>Profesión de Fe - Credo Niceno-Constantinopolitano</h3><p class="liturgy-text"><strong>Creo en un solo Dios, Padre todopoderoso... Amén.</strong></p>`,
                        prayerOfTheFaithful: `<h3>Oración de los Fieles</h3><p class="liturgy-text">Hermanos, oremos a Dios Padre... <strong>Te rogamos, óyenos.</strong> ... Por Jesucristo, nuestro Señor.<br><strong>Amén.</strong></p>`,
                        eucharisticPrayerII: (preface) => `<h3>Plegaria Eucarística II</h3><p class="liturgy-text">El Señor esté con ustedes...<br><strong>Es justo y necesario.</strong></p><p class="liturgy-text">${preface}</p><p class="liturgy-text"><strong>Santo, Santo, Santo...</strong></p><p class="liturgy-text">Santo eres en verdad, Señor... <strong>«TOMEN Y COMAN...»</strong> ... <strong>«TOMEN Y BEBAN...»</strong> ... Este es el Misterio de la fe.<br><strong>Anunciamos tu muerte...</strong> ... Por Cristo, con él y en él...<br><strong>Amén.</strong></p>`,
                        communionRite: `<h3>Rito de la Comunión</h3><p class="liturgy-text"><strong>Padre nostro...</strong> ... <strong>Tuyo es el reino...</strong> ... La paz del Señor... <strong>Cordero de Dios...</strong> ... <strong>Señor, no soy digno...</strong></p>`,
                        acnaPostCommunion: `<h3>Oración después de la Comunión (ACNA)</h3><p class="liturgy-text"><strong>Padre Celestial, te damos gracias... Amén.</strong></p>`,
                        concludingRites: `<h3>Rito de Conclusión</h3><p class="liturgy-text">El Señor esté con ustedes... La bendición de Dios todopoderoso... Pueden ir en paz.<br><strong>Demos gracias a Dios.</strong></p>`
                    };

                    const entranceProcession = `<h3>Procesión de Entrada</h3><p class="liturgy-text italic">(Se canta un himno o antífona de entrada apropiado)</p>`;
                    const introductoryRites = entranceProcession + templates.initialGreeting + templates.penitentialAct + (liturgy.omitGloria ? '' : templates.gloria) + `<h3>Oración Colecta</h3><p class="liturgy-text">${liturgy.prayers.collect}</p>`;
                    
                    let psalmContentHtml = `<strong>R. ${liturgy.readings.psalm.response}</strong><br><br>` + liturgy.readings.psalm.stanzas.join(`<br><br><strong>R. ${liturgy.readings.psalm.response}</strong><br><br>`);

                    let gospelAcclamationHtml = liturgy.omitAlleluia ? templates.gospelAcclamation(liturgy.readings.gospelAcclamationVerse) : templates.alleluia(liturgy.readings.alleluiaVerse);

                    const liturgyOfTheWord = `<h3>Primera Lectura: ${liturgy.readings.firstReading.ref}</h3><p class="liturgy-text">${liturgy.readings.firstReading.text}</p><h3>Salmo Responsorial: ${liturgy.readings.psalm.ref}</h3><p class="liturgy-text">${psalmContentHtml}</p>${liturgy.readings.secondReading ? `<h3>Segunda Lectura: ${liturgy.readings.secondReading.ref}</h3><p class="liturgy-text">${liturgy.readings.secondReading.text}</p>` : ''}${gospelAcclamationHtml}${templates.gospel(liturgy.readings.gospel)}<h3>Homilía</h3><p class="liturgy-text italic">(Reflexión sobre las lecturas)</p>${templates.credo}${templates.prayerOfTheFaithful}`;
                    
                    const liturgyOfTheEucharist = `<h3>Presentación de las Ofrendas</h3><p class="liturgy-text">Oren, hermanos...<br><strong>El Señor reciba de tus manos este sacrificio...</strong></p><h3>Oración sobre las Ofrendas</h3><p class="liturgy-text">${liturgy.prayers.offerings}</p>${templates.eucharisticPrayerII(liturgy.prayers.preface)}${templates.communionRite}`;
                    
                    const concludingRites = `<h3>Oración después de la Comunión</h3><p class="liturgy-text">${liturgy.prayers.postCommunion}</p>${templates.acnaPostCommunion}${templates.concludingRites}`;

                    const finalHtml = `<div class="bg-white p-6 rounded-lg shadow-md">
                                        <div class="liturgy-section"><h2>Ritos Iniciales</h2>${introductoryRites}</div>
                                        <div class="liturgy-section"><h2>Liturgia de la Palabra</h2>${liturgyOfTheWord}</div>
                                        <div class="liturgy-section"><h2>Liturgia Eucarística</h2>${liturgyOfTheEucharist}</div>
                                        <div class="liturgy-section"><h2>Ritos de Conclusión</h2>${concludingRites}</div>
                                    </div>`;

                    fullLiturgyUI.content.innerHTML = finalHtml;

                } else {
                    fullLiturgyUI.title.textContent = 'Liturgia no Disponible';
                    fullLiturgyUI.subtitle.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    fullLiturgyUI.content.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-md text-center"><p class="text-gray-600 py-16">Lo sentimos, la liturgia completa para este día aún no ha sido implementada.</p></div>`;
                }
            }


            function hideFullLiturgy() {
                mainContent.classList.remove('hidden');
                fullLiturgyView.classList.add('hidden');
            }

            function loadLogoFromStorage() {
                const savedLogo = localStorage.getItem('userLogo');
                if (savedLogo) {
                    logoImage.src = savedLogo;
                }
            }

            // --- BIBLE FUNCTIONS ---
            function loadAndInitializeBible() {
                initializeBible();
            }

            function initializeBible() {
                bibleNav.otBooks.innerHTML = '';
                bibleNav.ntBooks.innerHTML = '';
                
                bibleData.forEach((book, index) => {
                    const button = document.createElement('button');
                    button.className = 'book-button';
                    button.textContent = book.name;
                    button.dataset.bookIndex = index;

                    if (book.testament === 'OT') {
                        bibleNav.otBooks.appendChild(button);
                    } else {
                        bibleNav.ntBooks.appendChild(button);
                    }
                });

                const accordionHeaders = document.querySelectorAll('.accordion-header');
                accordionHeaders.forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('is-open');
                    });
                });
            }

            function showChapters(bookIndex, buttonElement) {
                const bookData = bibleData[bookIndex];
                if (!bookData) return;
                
                if (activeBookButton) {
                    activeBookButton.classList.remove('active');
                }
                activeBookButton = buttonElement;
                activeBookButton.classList.add('active');

                bibleNav.bookListContainer.classList.add('hidden');
                bibleNav.chapterListContainer.classList.remove('hidden');
                bibleNav.chapterListTitle.textContent = bookData.name;
                bibleNav.chapterGrid.innerHTML = '';
                bibleNav.chapterListContainer.dataset.currentBook = bookIndex;

                for (let i = 1; i <= bookData.chapters.length; i++) {
                    const button = document.createElement('button');
                    button.className = 'chapter-button';
                    button.textContent = i;
                    button.dataset.chapterIndex = i - 1;
                    bibleNav.chapterGrid.appendChild(button);
                }
            }

            function showChapterContent(bookIndex, chapterIndex, chapterButton) {
                const bookData = bibleData[bookIndex];
                const chapterData = bookData.chapters[chapterIndex];
                
                document.querySelectorAll('#chapter-grid .chapter-button').forEach(btn => btn.classList.remove('active'));
                chapterButton.classList.add('active');
                bibleFlexContainer.classList.add('mobile-content-focused');

                bibleContent.innerHTML = '';
                bibleContent.scrollTop = 0;

                const title = document.createElement('h3');
                title.className = "text-2xl font-bold mb-4";
                title.textContent = `${bookData.name} ${parseInt(chapterIndex) + 1}`;
                bibleContent.appendChild(title);

                const p = document.createElement('p');
                chapterData.forEach((verse) => {
                    const sup = document.createElement('sup');
                    sup.textContent = verse.verse;
                    p.appendChild(sup);
                    p.appendChild(document.createTextNode(verse.text + ' '));
                });
                bibleContent.appendChild(p);
            }


            // --- EVENT LISTENERS ---
            Object.keys(mainNavButtons).forEach(key => {
                if(mainNavButtons[key]) {
                    mainNavButtons[key].addEventListener('click', () => switchView(key));
                }
            });

            backToCalendarBtn.addEventListener('click', hideFullLiturgy);
            printBtn.addEventListener('click', () => window.print());
            downloadDocxBtn.addEventListener('click', () => {
                const title = fullLiturgyUI.title.textContent;
                const subtitle = fullLiturgyUI.subtitle.textContent;
                const contentElement = document.getElementById('full-liturgy-content').cloneNode(true);
                
                const liturgyBody = contentElement.querySelector('.bg-white');
                if (!liturgyBody) return;

                const headerHtml = `...`; // Same as previous version
                const contentHtml = `<!DOCTYPE html><html>...<body>${headerHtml}${liturgyBody.innerHTML}</body></html>`;

                const converted = htmlDocx.asBlob(contentHtml, { orientation: 'landscape' });
                saveAs(converted, `${title}.docx`);
            });
            
            cardsContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.liturgical-card');
                if (card && card.dataset.date) {
                    const [year, month, day] = card.dataset.date.split('-').map(Number);
                    const selectedDate = new Date(year, month - 1, day);
                    showFullLiturgy(selectedDate);
                }
            });

            // --- BIBLE EVENT LISTENERS ---
            const handleBookClick = (e) => {
                if (e.target.classList.contains('book-button')) {
                    showChapters(e.target.dataset.bookIndex, e.target);
                }
            };
            bibleNav.otBooks.addEventListener('click', handleBookClick);
            bibleNav.ntBooks.addEventListener('click', handleBookClick);

            bibleNav.backToBooksBtn.addEventListener('click', () => {
                bibleNav.bookListContainer.classList.remove('hidden');
                bibleNav.chapterListContainer.classList.add('hidden');
                if (activeBookButton) { activeBookButton.classList.remove('active'); activeBookButton = null; }
            });

            backToChaptersMobileBtn.addEventListener('click', () => {
                bibleFlexContainer.classList.remove('mobile-content-focused');
            });

            bibleNav.chapterGrid.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    const bookIndex = bibleNav.chapterListContainer.dataset.currentBook;
                    showChapterContent(bookIndex, e.target.dataset.chapterIndex, e.target);
                }
            });


            // --- THEOLOGY POPUP LISTENERS ---
            fullLiturgyView.addEventListener('click', function(e) {
                const refLink = e.target.closest('.ref-link');
                if (refLink) {
                    e.preventDefault();
                    e.stopPropagation();
                    const data = JSON.parse(refLink.dataset.term);
                    
                    theologyPopupContent.innerHTML = `<h5>Término Teológico</h5>...`; // Simplified for brevity
                    theologyPopup.style.display = 'block';
                }
            });

            theologyPopupClose.addEventListener('click', () => {
                theologyPopup.style.display = 'none';
            });

            document.addEventListener('click', function(e) {
                if (theologyPopup.style.display === 'block' && !theologyPopup.contains(e.target) && !e.target.closest('.ref-link')) {
                    theologyPopup.style.display = 'none';
                }
            }, true);

            // --- LOGO UPLOAD LISTENERS ---
            uploadLogoBtn.addEventListener('click', () => {
                logoUploader.click();
            });

            logoUploader.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const logoDataUrl = e.target.result;
                        localStorage.setItem('userLogo', logoDataUrl);
                        logoImage.src = logoDataUrl;
                    }
                    reader.readAsDataURL(file);
                }
            });

            // --- HEADER SCROLL LOGIC ---
            let lastScrollTop = 0;
            const mainHeader = document.getElementById('main-header');
            window.addEventListener("scroll", function() {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > lastScrollTop && scrollTop > mainHeader.offsetHeight) {
                    mainHeader.classList.add('header-hidden');
                } else {
                    mainHeader.classList.remove('header-hidden');
                }
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            }, false);


            // --- INITIALIZATION ---
            function initializeApp() {
                setTimeout(() => {
                    splashScreen.classList.add('fade-out');
                    mainContent.classList.remove('opacity-0');
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 1500);
                }, 2000);

                loadLogoFromStorage();
                switchView('home');
                renderLiturgicalCards();
                loadAndInitializeBible();
            }
            initializeApp();
        });
    </script>
</body>
</html>
